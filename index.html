<!DOCTYPE html>
<html lang="te">
<head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>Mantra OCR </title>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com" />
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
Â  Â  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
<link rel="stylesheet" href="styles.css" />

</head>
<body>
Â  Â  <div class="main-container">
Â  Â  Â  Â  <h1>à°…à°•à±à°·à°° à°¸à°¾à°§à°¨</h1>
Â  Â  Â  Â  <div class="status info" id="status">à°®à±Šà°¦à°²à± à°ªà±†à°Ÿà±à°Ÿà°¡à°¾à°¨à°¿à°•à°¿ à°’à°• à°«à±‹à°Ÿà±‹à°¨à± à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿</div>
Â  Â  Â  Â  <div class="section" id="ocrSection">
Â  Â  Â  Â  Â  Â  <h2>1. à°šà°¿à°¤à±à°°à°‚ à°¨à±à°‚à°¡à°¿</h2>
Â  Â  Â  Â  Â  Â  <div class="flex-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button" id="uploadBtn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  à°šà°¿à°¤à±à°°à°¾à°¨à±à°¨à°¿ à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="imageInput" class="file-input" accept="image/*" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="button" id="btnOcr" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â OCRà°¨à± à°ªà±à°°à°¾à°°à°‚à°­à°¿à°‚à°šà°‚à°¡à°¿
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="ocrSpinner" class="spinner"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <img id="preview" alt="Uploaded Image" />
Â  Â  Â  Â  Â  Â  <div style="margin-top: 1.5rem; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="ocrText">OCR à°«à°²à°¿à°¤à°‚ (à°¸à°µà°°à°¿à°‚à°šà°‚à°¡à°¿ & à°ªà°¿à°šà±â€Œà°²à°¨à± à°—à±à°°à±à°¤à°¿à°‚à°šà°‚à°¡à°¿)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="ocrText" placeholder="OCR result will appear here"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pitch-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button secondary-btn" id="btnPitchHigh">High Pitch (à°‰à°¦à°¾à°¤à±à°¤à°‚) ğŸ”¼</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button secondary-btn" id="btnPitchLow">Low Pitch (à°…à°¨à±à°¦à°¾à°¤à±à°¤à°‚) ğŸ”½</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button secondary-btn" id="btnClear">à°…à°¨à±à°¨à°¿ à°•à±à°²à°¿à°¯à°°à± à°šà±‡à°¯à°‚à°¡à°¿ ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 2rem;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="mantraTitle">à°®à°‚à°¤à±à°°à°‚ à°¶à±€à°°à±à°·à°¿à°•:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="mantraTitle" placeholder="e.g., SriGayatriMantra" />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 1rem;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="mantraDescription">à°µà°¿à°µà°°à°£ :</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="mantraDescription" style="min-height: 80px;" placeholder="à°®à°‚à°¤à±à°°à°‚ à°¯à±Šà°•à±à°• à°¸à°‚à°•à±à°·à°¿à°ªà±à°¤ à°µà°¿à°µà°°à°£"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex-container">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="button" id="btnSaveMantra">à°•à±Šà°¤à±à°¤ à°®à°‚à°¤à±à°°à°¾à°¨à±à°¨à°¿ à°¸à±‡à°µà± à°šà±‡à°¯à°‚à°¡à°¿ Â âœ¨</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="section" id="viewMantraSection">
Â  Â  Â  Â  Â  Â  <h2>2. à°®à°‚à°¤à±à°°à°¾à°²à°¨à± à°µà±€à°•à±à°·à°¿à°‚à°šà°‚à°¡à°¿ & à°¸à°µà°°à°¿à°‚à°šà°‚à°¡à°¿</h2>
Â  Â  Â  Â  Â  Â  <p style="color: var(--light-text-color);">à°®à°‚à°¤à±à°°à°‚ à°•à°‚à°Ÿà±†à°‚à°Ÿà±â€Œà°¨à± à°µà±€à°•à±à°·à°¿à°‚à°šà°¡à°¾à°¨à°¿à°•à°¿ à°²à±‡à°¦à°¾ à°ªà°¿à°šà±â€Œà°²à°¨à± à°—à±à°°à±à°¤à°¿à°‚à°šà°¿ à°¸à°µà°°à°¿à°‚à°šà°¡à°¾à°¨à°¿à°•à°¿ à°’à°• à°®à°‚à°¤à±à°°à°¾à°¨à±à°¨à°¿ à°à°‚à°šà±à°•à±‹à°‚à°¡à°¿.</p>
Â  Â  Â  Â  Â  Â  <div class="tab-container" id="tabContainer"></div>
Â  Â  Â  Â  Â  Â  <div class="mantra-card" id="mantraDisplayCard">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mantraTitleDisplay"><h3></h3></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mantraDescriptionDisplay"><p></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mantraContentDisplay" class="pitch-display">à°¦à°¾à°¨à°¿ à°•à°‚à°Ÿà±†à°‚à°Ÿà±â€Œà°¨à± à°šà±‚à°¡à°Ÿà°¾à°¨à°¿à°•à°¿ à°’à°• à°®à°‚à°¤à±à°°à°‚ à°Ÿà±à°¯à°¾à°¬à±â€Œà°¨à± à°à°‚à°šà±à°•à±‹à°‚à°¡à°¿</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button secondary-btn" id="btnEditMantra" disabled>à°®à°‚à°¤à±à°°à°¾à°¨à±à°¨à°¿ à°¸à°µà°°à°¿à°‚à°šà°‚à°¡à°¿</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="button" id="btnDownloadMantra">JSONà°¨à± à°¡à±Œà°¨à±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <script>
Â  Â  Â  Â  let ritualsMantras = JSON.parse(localStorage.getItem('ritualsMantras')) || {
Â  Â  Â  Â  Â  Â  /* your initial mantra data as per your code */
Â  Â  Â  Â  };
Â  Â  Â  Â  const statusElement = document.getElementById('status');
Â  Â  Â  Â  const imageInput = document.getElementById('imageInput');
Â  Â  Â  Â  const preview = document.getElementById('preview');
Â  Â  Â  Â  const btnOcr = document.getElementById('btnOcr');
Â  Â  Â  Â  const ocrSpinner = document.getElementById('ocrSpinner');
Â  Â  Â  Â  const ocrTextarea = document.getElementById('ocrText');
Â  Â  Â  Â  const btnPitchHigh = document.getElementById('btnPitchHigh');
Â  Â  Â  Â  const btnPitchLow = document.getElementById('btnPitchLow');
Â  Â  Â  Â  const btnClear = document.getElementById('btnClear');
Â  Â  Â  Â  const mantraTitleInput = document.getElementById('mantraTitle');
Â  Â  Â  Â  const mantraDescriptionInput = document.getElementById('mantraDescription');
Â  Â  Â  Â  const btnSaveMantra = document.getElementById('btnSaveMantra');
Â  Â  Â  Â  const tabContainer = document.getElementById('tabContainer');
Â  Â  Â  Â  const mantraTitleDisplay = document.getElementById('mantraTitleDisplay');
Â  Â  Â  Â  const mantraDescriptionDisplay = document.getElementById('mantraDescriptionDisplay');
Â  Â  Â  Â  const mantraContentDisplay = document.getElementById('mantraContentDisplay');
Â  Â  Â  Â  const btnEditMantra = document.getElementById('btnEditMantra');
Â  Â  Â  Â  const btnDownloadMantra = document.getElementById('btnDownloadMantra');
Â  Â  Â  Â  let worker;
Â  Â  Â  Â  let currentFile = null;
Â  Â  Â  Â  let pitchMarks = [];
Â  Â  Â  Â  let currentMantraKey = null;

Â  Â  Â  Â  function updateStatus(message, type = 'info') {
Â  Â  Â  Â  Â  Â  statusElement.textContent = message;
Â  Â  Â  Â  Â  Â  statusElement.className = `status ${type}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  async function initWorker() {
Â  Â  Â  Â  Â  Â  updateStatus("Initializing OCR engine...", 'info');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  worker = await Tesseract.createWorker({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  langPath: "https://cdn.jsdelivr.net/npm/tessdata@4.0.0"
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  await worker.load();
Â  Â  Â  Â  Â  Â  Â  Â  await worker.loadLanguage("tel");
Â  Â  Â  Â  Â  Â  Â  Â  await worker.initialize("tel");
Â  Â  Â  Â  Â  Â  Â  Â  worker.setLogger(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (m.status === "recognizing text") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(`Recognizing text: ${(m.progress * 100).toFixed(2)}%`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("OCR engine ready. Upload an image to start.", 'success');
Â  Â  Â  Â  Â  Â  Â  Â  renderMantraTabs();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("OCR initialization error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("Failed to initialize OCR engine.", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  initWorker();

Â  Â  Â  Â  imageInput.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  if (imageInput.files.length === 0) return;
Â  Â  Â  Â  Â  Â  currentFile = imageInput.files[0];
Â  Â  Â  Â  Â  Â  preview.src = URL.createObjectURL(currentFile);
Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  updateStatus("Image loaded. Click 'Start OCR' to process.", 'info');
Â  Â  Â  Â  Â  Â  btnOcr.disabled = false;
Â  Â  Â  Â  Â  Â  ocrTextarea.value = "";
Â  Â  Â  Â  Â  Â  pitchMarks = [];
Â  Â  Â  Â  });

Â  Â  Â  Â  btnOcr.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  if (!currentFile || !worker) return;
Â  Â  Â  Â  Â  Â  btnOcr.disabled = true;
Â  Â  Â  Â  Â  Â  ocrSpinner.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  updateStatus("Performing OCR...", 'info');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data } = await worker.recognize(currentFile, 'tel');
Â  Â  Â  Â  Â  Â  Â  Â  const sanitizedText = data.text.replace(/[\u030D\u0323]/g, '').trim();
Â  Â  Â  Â  Â  Â  Â  Â  ocrTextarea.value = sanitizedText;
Â  Â  Â  Â  Â  Â  Â  Â  const segmenter = new Intl.Segmenter('te', { granularity: 'grapheme' });
Â  Â  Â  Â  Â  Â  Â  Â  const segments = Array.from(segmenter.segment(sanitizedText));
Â  Â  Â  Â  Â  Â  Â  Â  pitchMarks = Array(segments.length).fill('none');
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("OCR complete. Select text and click a pitch button.", 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("An error occurred during OCR.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  console.error("OCR Error:", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btnOcr.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  ocrSpinner.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function getGraphemeIndices(text, startIndex, endIndex) {
Â  Â  Â  Â  Â  Â  const segmenter = new Intl.Segmenter('te', { granularity: 'grapheme' });
Â  Â  Â  Â  Â  Â  const segments = Array.from(segmenter.segment(text));
Â  Â  Â  Â  Â  Â  let indices = [];
Â  Â  Â  Â  Â  Â  let charIndex = 0;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < segments.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const seg = segments[i].segment;
Â  Â  Â  Â  Â  Â  Â  Â  const segmentEndIndex = charIndex + seg.length;
Â  Â  Â  Â  Â  Â  Â  Â  if (segmentEndIndex > startIndex && charIndex < endIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indices.push(i);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  charIndex = segmentEndIndex;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return indices;
Â  Â  Â  Â  }

Â  Â  Â  Â  function preparePitches(pitchType) {
Â  Â  Â  Â  Â  Â  const fullText = ocrTextarea.value;
Â  Â  Â  Â  Â  Â  const startIndex = ocrTextarea.selectionStart;
Â  Â  Â  Â  Â  Â  const endIndex = ocrTextarea.selectionEnd;
Â  Â  Â  Â  Â  Â  if (startIndex === endIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please select some text in the OCR Output box first.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const selectedGraphemeIndices = getGraphemeIndices(fullText, startIndex, endIndex);
Â  Â  Â  Â  Â  Â  if (selectedGraphemeIndices.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please select some text in the OCR Output box first.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  selectedGraphemeIndices.forEach(index => {
Â  Â  Â  Â  Â  Â  Â  Â  pitchMarks[index] = pitchType;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updateStatus(`Pitches marked. You can now save the mantra or edit the text.`, 'info');
Â  Â  Â  Â  }
Â  Â  Â  Â  btnPitchHigh.addEventListener('click', () => preparePitches('high'));
Â  Â  Â  Â  btnPitchLow.addEventListener('click', () => preparePitches('low'));
Â  Â  Â  Â  btnClear.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  ocrTextarea.value = '';
Â  Â  Â  Â  Â  Â  imageInput.value = '';
Â  Â  Â  Â  Â  Â  preview.style.display = 'none';
Â  Â  Â  Â  Â  Â  btnOcr.disabled = true;
Â  Â  Â  Â  Â  Â  pitchMarks = [];
Â  Â  Â  Â  Â  Â  mantraTitleInput.value = '';
Â  Â  Â  Â  Â  Â  mantraDescriptionInput.value = '';
Â  Â  Â  Â  Â  Â  updateStatus('All OCR content cleared. Upload an image to begin.', 'info');
Â  Â  Â  Â  Â  Â  btnSaveMantra.textContent = 'Save New Mantra âœ¨';
Â  Â  Â  Â  Â  Â  currentMantraKey = null;
Â  Â  Â  Â  });

Â  Â  Â  Â  btnSaveMantra.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const title = mantraTitleInput.value.trim();
Â  Â  Â  Â  Â  Â  const description = mantraDescriptionInput.value.trim();
Â  Â  Â  Â  Â  Â  const fullText = ocrTextarea.value;
Â  Â  Â  Â  Â  Â  if (!title) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please provide a unique title.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const newKey = title.replace(/\s+/g, '');
Â  Â  Â  Â  Â  Â  if (newKey !== currentMantraKey && ritualsMantras.hasOwnProperty(newKey)) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`The title "${title}" already exists. Please choose a unique title.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (fullText.trim().length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('OCR output is empty. Please run OCR and mark text before saving.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const segmenter = new Intl.Segmenter('te', { granularity: 'grapheme' });
Â  Â  Â  Â  Â  Â  const segments = Array.from(segmenter.segment(fullText));
Â  Â  Â  Â  Â  Â  let mantraInstructions = [];
Â  Â  Â  Â  Â  Â  let currentLine = [];
Â  Â  Â  Â  Â  Â  segments.forEach((seg, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const char = seg.segment;
Â  Â  Â  Â  Â  Â  Â  Â  const pitch = pitchMarks[index];
Â  Â  Â  Â  Â  Â  Â  Â  if (char.includes('\n')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentLine.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraInstructions.push(currentLine);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentLine = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  let syllable = { char: char };
Â  Â  Â  Â  Â  Â  Â  Â  if (pitch && pitch !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  syllable.pitch = pitch;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  currentLine.push(syllable);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (currentLine.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  mantraInstructions.push(currentLine);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const newMantra = {
Â  Â  Â  Â  Â  Â  Â  Â  title: title,
Â  Â  Â  Â  Â  Â  Â  Â  description: description,
Â  Â  Â  Â  Â  Â  Â  Â  instructions: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantra: mantraInstructions
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  if (currentMantraKey && currentMantraKey !== newKey) {
Â  Â  Â  Â  Â  Â  Â  Â  delete ritualsMantras[currentMantraKey];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ritualsMantras[newKey] = newMantra;
Â  Â  Â  Â  Â  Â  currentMantraKey = newKey;
Â  Â  Â  Â  Â  Â  localStorage.setItem('ritualsMantras', JSON.stringify(ritualsMantras));
Â  Â  Â  Â  Â  Â  updateStatus(`Mantra "${title}" has been saved. You can now view it in the tabs below.`, 'success');
Â  Â  Â  Â  Â  Â  renderMantraTabs();
Â  Â  Â  Â  Â  Â  loadMantra(newKey);
Â  Â  Â  Â  Â  Â  mantraTitleInput.value = '';
Â  Â  Â  Â  Â  Â  mantraDescriptionInput.value = '';
Â  Â  Â  Â  Â  Â  btnSaveMantra.textContent = 'Save New Mantra âœ¨';
Â  Â  Â  Â  });

Â  Â  Â  Â  function renderMantraTabs() {
Â  Â  Â  Â  Â  Â  tabContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (const key in ritualsMantras) {
Â  Â  Â  Â  Â  Â  Â  Â  if (ritualsMantras.hasOwnProperty(key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mantra = ritualsMantras[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tabButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabButton.className = 'tab-button';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabButton.setAttribute('data-key', key);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const titleSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleSpan.textContent = mantra.title;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabButton.appendChild(titleSpan);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.textContent = 'X';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.className = 'delete-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.setAttribute('title', 'Delete Mantra');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (confirm(`Are you sure you want to delete the mantra "${mantra.title}"?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete ritualsMantras[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('ritualsMantras', JSON.stringify(ritualsMantras));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(`Mantra "${mantra.title}" has been deleted.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMantraTabs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentMantraKey === key) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraContentDisplay.innerHTML = "Select a mantra tab to view its content.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraTitleDisplay.innerHTML = `<h3></h3>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraDescriptionDisplay.innerHTML = `<p></p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnEditMantra.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentMantraKey = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnSaveMantra.textContent = 'Save New Mantra âœ¨';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraTitleInput.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mantraDescriptionInput.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ocrTextarea.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabButton.appendChild(deleteBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabButton.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadMantra(event.currentTarget.getAttribute('data-key'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnEditMantra.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabContainer.appendChild(tabButton);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadMantra(mantraKey) {
Â  Â  Â  Â  Â  Â  const ritual = ritualsMantras[mantraKey];
Â  Â  Â  Â  Â  Â  if (!ritual) {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(`Mantra "${mantraKey}" not found.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  currentMantraKey = mantraKey;
Â  Â  Â  Â  Â  Â  const hasPitchMarks = ritual.instructions.some(instruction =>
Â  Â  Â  Â  Â  Â  Â  Â  Array.isArray(instruction.mantra) && instruction.mantra.some(line => line.some(syl => syl.pitch))
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  btnEditMantra.disabled = !hasPitchMarks;
Â  Â  Â  Â  Â  Â  mantraTitleDisplay.innerHTML = `<h3>${ritual.title}</h3>`;
Â  Â  Â  Â  Â  Â  mantraDescriptionDisplay.innerHTML = `<p>${ritual.description}</p>`;
Â  Â  Â  Â  Â  Â  let outputHtml = '';
Â  Â  Â  Â  Â  Â  ritual.instructions.forEach(instruction => {
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof instruction.mantra === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputHtml += `<p style="font-family: 'Noto Sans Telugu', serif; font-size: 1.25rem;">${instruction.mantra}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (Array.isArray(instruction.mantra)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instruction.mantra.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let lineHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  line.forEach(syllable => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let pitchClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (syllable.pitch) pitchClass = ` ${syllable.pitch}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lineHtml += `<span class="pitch-marked-char${pitchClass}">${syllable.char}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputHtml += `<p style="margin: 0; padding: 0;">${lineHtml}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  mantraContentDisplay.innerHTML = outputHtml;
Â  Â  Â  Â  Â  Â  updateStatus(`"${ritual.title}" mantra loaded successfully.`, 'success');
Â  Â  Â  Â  }

Â  Â  Â  Â  btnEditMantra.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (!currentMantraKey) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please select a mantra to edit first.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const mantraToEdit = ritualsMantras[currentMantraKey];
Â  Â  Â  Â  Â  Â  mantraTitleInput.value = mantraToEdit.title;
Â  Â  Â  Â  Â  Â  mantraDescriptionInput.value = mantraToEdit.description;
Â  Â  Â  Â  Â  Â  let fullText = "";
Â  Â  Â  Â  Â  Â  let newPitchMarks = [];
Â  Â  Â  Â  Â  Â  mantraToEdit.instructions.forEach(instruction => {
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof instruction.mantra === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fullText += instruction.mantra;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (Array.isArray(instruction.mantra)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instruction.mantra.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  line.forEach(syllable => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fullText += syllable.char;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newPitchMarks.push(syllable.pitch || 'none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fullText += "\n";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  ocrTextarea.value = fullText.trim();
Â  Â  Â  Â  Â  Â  pitchMarks = newPitchMarks;
Â  Â  Â  Â  Â  Â  updateStatus(`Editing "${mantraToEdit.title}". Make changes and click 'Save Mantra' to update.`, 'info');
Â  Â  Â  Â  Â  Â  btnSaveMantra.textContent = 'Save Mantra';
Â  Â  Â  Â  Â  Â  document.getElementById('ocrSection').scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  mantraTitleInput.focus();
Â  Â  Â  Â  });

Â  Â  Â  Â  btnDownloadMantra.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const jsonData = JSON.stringify(ritualsMantras, null, 2);
Â  Â  Â  Â  Â  Â  const blob = new Blob([jsonData], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  a.download = 'ritualsMantras.json';
Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  updateStatus('Mantra data downloaded successfully.', 'success');
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
